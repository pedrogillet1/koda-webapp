name: TypeScript Checks

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**/*.ts'
      - 'frontend/**/*.ts'
      - 'frontend/**/*.tsx'
      - 'backend/package.json'
      - 'frontend/package.json'
      - 'backend/tsconfig.json'
      - 'frontend/tsconfig.json'
      - '.github/workflows/typescript-checks.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/**/*.ts'
      - 'frontend/**/*.ts'
      - 'frontend/**/*.tsx'
      - 'backend/package.json'
      - 'frontend/package.json'
      - 'backend/tsconfig.json'
      - 'frontend/tsconfig.json'

jobs:
  backend-typescript:
    name: Backend TypeScript Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üóÑÔ∏è Generate Prisma Client
        run: npx prisma generate
        continue-on-error: true

      - name: üîç Check TypeScript (Full)
        run: npx tsc --noEmit
        continue-on-error: true
        id: full-check

      - name: üîç Check Chat Files
        run: |
          echo "Checking critical chat files..."
          ERRORS=0

          # Check individual chat files
          FILES=(
            "src/controllers/chat.controller.ts"
            "src/controllers/rag.controller.ts"
            "src/services/chat.service.ts"
            "src/services/rag.service.ts"
            "src/routes/chat.routes.ts"
            "src/routes/rag.routes.ts"
          )

          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              if ! npx tsc --noEmit "$file" 2>&1 | grep -q "error TS"; then
                echo "‚úÖ $file passed"
              else
                echo "‚ùå $file has errors"
                npx tsc --noEmit "$file" 2>&1 | grep "error TS" | head -5
                ERRORS=$((ERRORS+1))
              fi
            else
              echo "‚ö†Ô∏è  $file not found"
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "‚ùå Found errors in $ERRORS critical chat files"
            exit 1
          fi

          echo ""
          echo "‚úÖ All critical chat files passed TypeScript checks"

      - name: üìä Generate TypeScript Report
        if: always()
        run: |
          echo "# TypeScript Check Report" > typescript-report.md
          echo "" >> typescript-report.md
          echo "## Summary" >> typescript-report.md
          echo "" >> typescript-report.md

          # Count errors
          ERROR_COUNT=$(npx tsc --noEmit 2>&1 | grep -c "error TS" || echo "0")

          echo "- Total TypeScript Errors: $ERROR_COUNT" >> typescript-report.md
          echo "- Critical Files Check: $(if [ $? -eq 0 ]; then echo '‚úÖ Passed'; else echo '‚ùå Failed'; fi)" >> typescript-report.md
          echo "" >> typescript-report.md

          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "## Top 20 Errors" >> typescript-report.md
            echo "" >> typescript-report.md
            echo '```' >> typescript-report.md
            npx tsc --noEmit 2>&1 | grep "error TS" | head -20 >> typescript-report.md
            echo '```' >> typescript-report.md
          fi

          cat typescript-report.md

      - name: üì§ Upload TypeScript Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-typescript-report
          path: backend/typescript-report.md
          retention-days: 30

  frontend-typescript:
    name: Frontend TypeScript Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üîç Check TypeScript
        run: |
          # For Create React App, we check using their built-in TypeScript checking
          if [ -f "node_modules/.bin/react-scripts" ]; then
            echo "Checking TypeScript with react-scripts..."
            # This will check TypeScript as part of the build process
            CI=true npm run build
          else
            echo "Running TypeScript compiler..."
            npx tsc --noEmit
          fi
        continue-on-error: true

      - name: üìä Frontend Check Summary
        if: always()
        run: |
          echo "Frontend TypeScript check completed"
          if [ $? -eq 0 ]; then
            echo "‚úÖ No TypeScript errors found"
          else
            echo "‚ö†Ô∏è  TypeScript errors found (non-blocking)"
          fi

  lint-backend:
    name: Lint Backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üßπ Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: üé® Check Prettier
        run: npm run format:check
        continue-on-error: true

  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    needs: [backend-typescript, frontend-typescript]

    strategy:
      matrix:
        component: [backend, frontend]

    defaults:
      run:
        working-directory: ./${{ matrix.component }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.component }}/package-lock.json

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üóÑÔ∏è Generate Prisma Client (Backend only)
        if: matrix.component == 'backend'
        run: npx prisma generate
        continue-on-error: true

      - name: üèóÔ∏è Build
        run: npm run build
        env:
          CI: true

      - name: üì§ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.component }}-build
          path: ${{ matrix.component }}/dist
          retention-days: 7

  summary:
    name: Check Summary
    runs-on: ubuntu-latest
    needs: [backend-typescript, frontend-typescript, lint-backend, build-test]
    if: always()

    steps:
      - name: üìä Generate Summary
        run: |
          echo "# TypeScript Checks Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Backend TypeScript: ${{ needs.backend-typescript.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend TypeScript: ${{ needs.frontend-typescript.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Linting: ${{ needs.lint-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Test: ${{ needs.build-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.backend-typescript.result }}" == "success" ] && [ "${{ needs.build-test.result }}" == "success" ]; then
            echo "‚úÖ All critical checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è  Some checks failed. Review the logs above." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ‚úÖ All Checks Passed
        if: needs.backend-typescript.result == 'success' && needs.build-test.result == 'success'
        run: echo "All TypeScript checks passed successfully!"

      - name: ‚ö†Ô∏è Some Checks Failed
        if: needs.backend-typescript.result != 'success' || needs.build-test.result != 'success'
        run: |
          echo "Some checks failed. Please review the errors and fix them."
          exit 1
