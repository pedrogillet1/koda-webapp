#!/bin/bash
# 03-optimize-prisma-schema.sh
# Guide for removing unused Prisma models
set -e

echo "ğŸ—‘ï¸ Prisma Schema Optimization Guide"
echo ""
echo "âš ï¸ ANALYSIS RESULTS"
echo ""
echo "After analyzing the codebase, these models are CONFIRMED UNUSED:"
echo "(No prisma.modelName calls found outside database.ts aliases)"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "SAFE TO REMOVE (20 models) - No direct queries:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "1.  ChatDocument"
echo "2.  MessageAttachment"
echo "3.  CloudIntegration"
echo "4.  Notification"
echo "5.  Role"
echo "6.  Permission"
echo "7.  RolePermission"
echo "8.  UserRole"
echo "9.  RoleHierarchy"
echo "10. DocumentTemplate"
echo "11. DocumentEditHistory"
echo "12. AnalysisSession"
echo "13. SessionDocument"
echo "14. UserInsight"
echo "15. ConversationSummary"
echo "16. InteractionMetadata"
echo "17. PracticalRecommendation"
echo "18. TrendPattern"
echo "19. KnowledgeEntry"
echo "20. FolderSummary"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "KEEP THESE (11 models) - Actually used in code:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "â€¢ DocumentEmbedding - used in analytics.service.ts"
echo "â€¢ DocumentSummary - used in delete-all-documents.ts"
echo "â€¢ DocumentEntity - used in delete-all-documents.ts"
echo "â€¢ DocumentKeyword - used in delete-all-documents.ts"
echo "â€¢ ChatContext - used in analytics.service.ts"
echo "â€¢ APIUsage - used in analytics.service.ts"
echo "â€¢ ExcelSheet - used in delete-all-documents.ts"
echo "â€¢ ExcelCell - used in delete-all-documents.ts"
echo "â€¢ ConversationChunk - used in multiple services"
echo "â€¢ ConversationIndex - used in infiniteConversationMemory"
echo "â€¢ ConversationContextState - used in infiniteConversationMemory"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "REMOVAL STEPS:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Step 1: Remove relations from parent models"
echo "  - User model: Remove cloudIntegrations, conversationSummaries,"
echo "                notifications, interactionMetadata, insights"
echo "  - Message model: Remove chatDocuments, attachments"
echo "  - Reminder model: Remove notifications"
echo "  - GeneratedDocument: Remove editHistory, template relation"
echo ""
echo "Step 2: Delete the unused model definitions from schema.prisma"
echo ""
echo "Step 3: Run migration:"
echo "  cd backend"
echo "  npx prisma migrate dev --name remove_unused_models"
echo ""
echo "Step 4: Regenerate client:"
echo "  npx prisma generate"
echo ""
echo "Step 5: Update database.ts to remove aliases for deleted models"
echo ""
echo "Step 6: Test the application"
echo ""
echo "âš ï¸ CAUTION: This is a DESTRUCTIVE operation."
echo "   Make sure you have a database backup before proceeding."
echo ""
echo "ğŸ’¾ Schema backup created at: prisma/schema.prisma.backup-*"
echo ""
